# Execution
Defines GraphQLFetcher trait and implementations.
GraphQLFetcher takes a query and returns a stream of responses, one primary and any number of patches.

## Implementations
* Federated (IN PROGRESS) - Combines several subgraphs into a single federated response stream consisting of a primary 
  response an any number of patch responses.
* HttpSubgraphFetcher - Uses reqwest to fetch a stream of responses from a subgraph. For subgraphs that do not support 
  streaming a stream with a single primary response is returned.

The federated response stream is a series of flatmaps on subgraph queries. Streams from subgraphs are split into the 
primary response and a stream of patches.

To goal is to pass the caller a federated primary response, and a stream of federated patches.

## Federation algorithm
The two main components in the federation algorithm are:
* `Traverser` - A threaadsafe object that can be sent through streams.
  
  Each traverser has a path into the output document, and is responsible for:
  * merging new content.
  * adding errors with the correct path.
  * collating patch streams.
  * spawning descendant traversers that match a given path relative to its own.
  
All content except the path is shared between all traversers and their descendants.

* `FederatedGraph` - A fetcher that transforms a request stream such that the correct output is generated by:
  
  1. Generating the query plan.
  1. Creating a starting stream of one root traverser.
  1. Visiting the query plan with the traverser stream.
  1. When traversal has completed taking the output and creating a response.
  
For example:
![Federation sequence diagram](./images/sequence.svg)
1. A query plan is generated from the request.
1. The initial content is fetched.
1. The traverser is expanded. A stream of child traversers is generated for a fetch.
1. Parallel execution takes place. The traversers are duplicated, expanded and then sent to further fetches.
4. The final result is extracted from the root traverser.

